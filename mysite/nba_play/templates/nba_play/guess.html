{% extends "nba_play/base.html" %}
{% block title %}Guess the Player{% endblock %}

{% block content %}
  <div class="container">
    <h2>Guess the Player</h2>

    <div class="game">
      <div class="game-type">
        <input type="radio" id="practice" value="practice" name="game-type">
        <label for="practice">Practice</label>
  
        <input type="radio" id="timed" value="timed" name="game-type" checked>
        <label for="timed">Timed</label>
      </div>

      <div class="game-box">
        <form id="start-form">
          {% csrf_token %}
          <button class="button" type="submit">Start Game!</button>
        </form>

        <div class="guess-options" hidden>
          <div class="user-guess-text">
            <label id="enter-name-text" for="user-text">Enter Player Name:</label>
            <input type="text" id="user-text" autocomplete="off">
          </div>
          <button class="button skip-button">Skip</button>
        </div>
        

        <button class="button play-again-button" hidden>Play Again!</button>

        <div class="score-board">

          <div class="data" id="score">
            <span>Score</span>
            <div class="data-value" id="score-value">0</div>
          </div>
          <div id="pause" style="visibility:hidden">
            <button class="pause-button"><i class="fa-solid fa-pause"></i></button>
          </div>
          <div class="data" id="time">
            <span>Time</span>
            <div class="data-value" id="time-value">1:00</div>
          </div>

        </div>

      </div>

      <!-- <div>
        <button class="button resume-button">Resume</button>
      </div> -->


      <div class="players"></div>
      <button class="button give-up-button" hidden>Give Up!</button>
    </div>

    <div>
      {% if not user.is_authenticated %}
        <p>Want to save your results? Create an account <a href="/register">here</a></p>
      {% endif %}
    </div>


  </div>

  <script>
    let form = document.getElementById('start-form');
    form.addEventListener('submit', startGame);

    let intervalId;
    let seconds;


    /**
    * Starts the game 
    */ 
    function startGame(e){
      e.preventDefault();
      changeStartPage();
      
      document.querySelector('.give-up-button').addEventListener("click", endGame);
      document.querySelector('.skip-button').addEventListener('click', playerTransition);
      // document.querySelector('.pause-button').addEventListener('click', pauseGame);

      document.querySelector("#time-value").innerText = "1:00";
      seconds = 60;
      document.querySelector("#score-value").innerText = 0;

      intervalId = setInterval(gameTimer, 100); // timer

      getRandomPlayer()
      .then(([last_name, first_name]) => {
        document.querySelector("#user-text").addEventListener('keyup', checkCorrect);
      });

    }

    function changeStartPage(){
      document.getElementById("time-value").style.color = "#000";
      document.getElementById("start-form").style.display = "none"; //removes start game button
      document.querySelector('.guess-options').style.display = "flex"; //adds typing and skip button
      document.querySelector(".game-type").style.display = "none"; //practice or timed radio
      document.getElementById("pause").style.visibility = "visible"; //adds pause button
      document.querySelector(".play-again-button").style.display = "none";
      document.querySelector(".give-up-button").style.display = "block";
    }
    
    /**
    * Maintains game timer.
    */
    function gameTimer() {
      seconds = (seconds - 0.1).toFixed(1);
      time_value = document.getElementById('time-value')
      time_value.textContent = seconds;
      if (seconds < 5.1){
        time_value.style.color = 'red';
      }
      if (seconds < 0.1){
        endGame();
      }
    }

    // function pauseGame(){
    //   clearInterval(intervalId);
    //   // create a resume button that we can click
    //   // paused text
    //   // show time remaining and score but make everything else hidden
    //   // if resume button clicked, then setInterval again

    //   document.querySelector('.resume-button').addEventListener('click', () => {
    //     intervalId = setInterval(gameTimer, 100);
    //   })
    // }

    /**
    * Gets random player. Returns a promise
    */
    function getRandomPlayer() {
      document.getElementById('user-text').value = "";
      document.getElementById('user-text').focus();
      return new Promise((resolve, reject) => {
        fetch('/get_random_players')
        .then((res) => res.json())
        .then((players) => {
          let player = players[0]
          let output = `<div class="player">
            <img class="player-image" 
            src="https://cdn.nba.com/headshots/nba/latest/260x190/${player.nba_id}.png" 
            alt=""></div>`
          document.querySelector('.players').innerHTML = output;
          last_name = player.last_name;
          first_name = player.first_name;
          resolve([last_name, first_name]);
        });
      });
    }

    // let is_guess_processing = false;
    /**
    * Checks if user input is correct. 
    */
    function checkCorrect(){
      // if (is_guess_processing) {
      //   return; // If a guess is already being processed, do nothing
      // }

      // is_guess_processing = true;

      let guess = document.querySelector('#user-text').value;
      let player_full_name = `${first_name} ${last_name}`;

      if(guess.toLowerCase() == last_name.toLowerCase() || 
      guess.toLowerCase() == player_full_name.toLowerCase()){
        let score = document.querySelector('#score-value');
        let new_value = parseInt(score.innerText) + 1;
        score.innerHTML = new_value;
        playerTransition();
        // special words: Jr., II, IV, III, Sr.
      }

      // setTimeout(() => {
      //   is_guess_processing = false;
      // }, 100);

    }

    function endGame() {
      clearInterval(intervalId);
      let play_again_button = document.querySelector(".play-again-button");
      play_again_button.style.display = "block";
      play_again_button.addEventListener('click', startGame);
      document.querySelector('.guess-options').style.display = "none";
      document.getElementById("pause").style.visibility = "hidden";
      document.querySelector(".give-up-button").style.display = "none";
    }

    
    function playerTransition() {
      document.querySelector('.player');
      let txt = document.createTextNode(`${first_name} ${last_name}`);
      document.querySelector('.player').appendChild(txt);
      // setTimeout(() => {
      //   getRandomPlayer();
      // }, 500);
      // pause timer as well
      getRandomPlayer();
    }
      // timer needs to continue when we swap tabs
      // also have practice mode where there's no timer
  </script>

{% endblock %}